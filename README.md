# ChillPill Firmware (STM32F103, CubeIDE)

Layered firmware for the ChillPill machine using STM32 HAL.

## Layout
- **Core/Inc, Core/Src**: application code for actuators, sensors, control FSM
  components, configuration, HAL glue, and system support (`actuators`,
  `sensors`, `lights`, `buttons`, `irq_handler_callback`, `user_settings`,
  `finite_state_machine`, `pid_controller`, `fault_handler`, `factory_test`,
  `estimator`, `flash_parms`, `stm32f1xx_hal_*`, `syscalls`, `sysmem`,
  `system_stm32f1xx`, `control_config`, `build_config`).
- **Drivers/**: CMSIS + STM32F1xx HAL driver (vendor code, committed)
- **Startup/**: startup assembly and linker/startup bits (as generated by CubeIDE)

## Build
This repository ships with a standalone `makefile`, so you can build the firmware
directly from the command line:

```sh
make        # compile and link PLU.elf, then emit HEX/BIN/MAP/LST outputs
make clean  # remove build/ plus PLU.elf/hex/bin/map/list
```

The makefile expects the GNU Arm Embedded toolchain (`arm-none-eabi-gcc`,
`arm-none-eabi-objcopy`, etc.) to be available on your `PATH`. CubeIDE ships
this toolchain, or you can install it separately from Arm.

Running `make` writes intermediate object files into `build/` and produces
`PLU.elf`, `PLU.hex`, `PLU.bin`, `PLU.map`, and `PLU.list` alongside the
makefile. These artefacts are ignored by Git so the outputs stay local, but you
can pick up the generated firmware binaries directly from the repository root
after a build.

## Init order (high level)
HAL & clocks → MSP/IT → `sensors_init`, `actuators_init`, `lights_init`, `buttons_init`, `user_settings_init` → `estimator_init`, `pid_init`, `fsm_init`.

## Notes
- No secrets in repo. If needed, create `private_config.h` (ignored) and commit `private_config.h.example`.
- The compile-time switch for the control FSM lives in `Core/Inc/build_config.h`
  as `ENABLE_CONTROL_FSM` (default `0`). Leave it disabled until the FSM is
  implemented, then flip it to `1` (or pass `-DENABLE_CONTROL_FSM=1` to the
  compiler) to re-enable the FSM code paths.

chillpill-firmware/
├── .gitignore
├── LICENSE
├── README.md
├── PLU.ioc
├── makefile
├── objects.list        ⟵ (build helper, can be regenerated)
├── objects.mk          ⟵ (build helper, can be regenerated)
├── sources.mk          ⟵ (build helper, can be regenerated)
├── PLU.map             ⟵ (build artifact)
├── PLU.list            ⟵ (build artifact)
├── PLU.bin             ⟵ (build artifact)
├── PLU.elf             ⟵ (build artifact)
│
├── Core/
│   ├── STM32F103C8TX_FLASH.ld      ⟵ linker script
│   │
│   ├── Inc/
│   │   ├── actuators.h
│   │   ├── build_config.h
│   │   ├── buttons.h
│   │   ├── control_config.h
│   │   ├── debug_log.h
│   │   ├── estimator.h
│   │   ├── factory_test.h
│   │   ├── fault_handler.h
│   │   ├── finite_state_machine.h
│   │   ├── flash_parms.h
│   │   ├── irq_handler_callback.h
│   │   ├── lights.h
│   │   ├── main.h
│   │   ├── pid_controller.h
│   │   ├── sensors.h
│   │   ├── stm32f1xx_hal_conf.h
│   │   ├── stm32f1xx_it.h
│   │   └── user_settings.h
│   │
│   ├── Src/
│   │   ├── actuators.c
│   │   ├── buttons.c
│   │   ├── control_config.c
│   │   ├── estimator.c
│   │   ├── factory_test.c
│   │   ├── fault_handler.c
│   │   ├── finite_state_machine.c
│   │   ├── flash_parms.c
│   │   ├── irq_handler_callback.c
│   │   ├── lights.c
│   │   ├── main.c
│   │   ├── pid_controller.c
│   │   ├── sensors.c
│   │   ├── stm32f1xx_hal_msp.c
│   │   ├── stm32f1xx_it.c
│   │   ├── syscalls.c
│   │   ├── sysmem.c
│   │   └── system_stm32f1xx.c
│   │
│   └── Startup/
│       └── startup_stm32f103c8tx.s
│
└── Drivers/                      ⟵ third-party / ST
    ├── CMSIS/
    └── STM32F1xx_HAL_Driver/
